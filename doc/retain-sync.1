\# INSTRUCTIONS FOR UPDATING THIS MAN PAGE
\#
\# Run the script 'man-gen.sh' in the 'gh-pages' branch to generate an html
\# copy of this man page.
\#     ./man-gen.sh retain-sync.1

.TH RETAIN-SYNC 1 "2016-10-10" "" ""
.SH NAME
retain-sync \- distribute files based on how frequently they are accessed
.SH SYNOPSIS
\fBretain-sync\fR [\fIglobal_options\fR] \fIcommand\fR [\fIcommand_options\fR] [\fIcommand_arg\fR]
.SH DESCRIPTION
\fBretain-sync\fR is a program that distributes files between a local and
remote directory based on how frequently they're accessed with the intent of
conserving disk space. This remote directory can be on a separate hard drive or
a seprate machine entirely (using sshfs). Files are prioritized based on how
frequently and recently they've been accessed as well as the file size. The
highest-priority files are kept in the local directory for quick access, while
lower priority files are moved to the remote directory to conserve disk space.
It uses symbolic links to allow files in the remote directory to be accessible
from the local one. The user can specify how much data they want to remain in
the local directory at any given point in time (referred to as the "storage
limit"). Multiple local directories can be synced concurrently with either
different remote directories or the same one. Since local directories on
different machines can pair with the same remote directory, \fBretain-sync\fR
can be used to sync files between machines.
.sp
\fBretain-sync\fR deliberately ignores hidden files and directories, meaning
that they never leave the local directory. The program currently does not
support file names containing newlines, but other characters should work fine.
\fBretain-sync\fR does not require root access, and is meant to run as an
unprivileged user. If the remote directory is located on a separate machine,
\fBretain-sync\fR does not need to be installed on that machine to function,
although you do need to have passwordless ssh access to it (i.e. via public key
authentication with an ssh agent). For the sake of redundancy, files stay in
the remote directory and are copied, not moved, to the local directory as space
permits.
.sp
For every pair of directories you wish to sync, a configuration must first be
generated using the \fBinitialize\fR command.
.SH GLOBAL OPTIONS
\fB--help\fR
.RS 4
Display a usage message and exit.
.RE
.PP
\fB--version\fR
.RS 4
Print version number and exit.
.RE
.PP
\fB-q\fR, \fB--quiet\fR
.RS 4
Suppress all non-error output.
.SH COMMANDS
\fBinitialize\fR [\fIoptions\fR] \fIpath\fR
.RS 4
Prepare the local directory \fIpath\fR for syncing by moving its contents to
the remote directory and generating a configuration for it. The user will be
prompted to give a name for the configuration, information about the server and
the storage limit. At the input prompts, all characters are taken literally
except single quotes, double quotes and backslashes, which must be escaped.
Backslash control sequences are not interpreted.
.sp
\fB-e\fR, \fB--exclude\fR \fIfile\fR
.RS 4
Get a list of file/directory paths from \fIfile\fR (one per line) that will be
excluded from syncing, meaning that they will never leave the local directory
(see \fBEXCLUDING\fR). If \fIfile\fR is '-', then a newline-separated list of
file paths will be accepted from stdin. File paths specified here can be
relative or absolute, and will be converted to the proper format and added to
the 'exclude' file automatically once it is generated.
.RE 2
.PP
\fB-t\fR, \fB--template\fR \fIfile\fR
.RS 4
Get settings for the configuration from the template \fIfile\fR instead of
prompting the user interactively. The user will still be prompted for the name
of the configuration and any mandatory information that is missing from the
template. A blank template can usually be found at
/usr/local/share/retain-sync/config-template.
.RE 2
.PP
\fB-a\fR, \fB--add-remote\fR
.RS 4
Instead of moving local files to an empty remote directory, start with an
existing remote directory and an empty local directory. Using this option, it
is possible for two or more configurations to share a remote directory, which
means that \fBretain-sync\fR can be used to sync files between machines.
.RE 1
.PP
\fBsync\fR \fIconfig\fR|\fIpath\fR
.RS 4
Redistribute files between the local and remote directories based on their
priority and update the remote directory with any new or deleted files. This
command accepts the absolute path of a local initialized directory or the name
of its configuration. This command is run automatically once an hour by the
daemon (see \fBSYNCING\fR).
.RE
.PP
\fBreset\fR [\fIoptions\fR] \fIconfig\fR|\fIpath\fR
.RS 4
Retrieve all files from the remote directory and de-initialize the local
directory. This command accepts the absolute path of a local initialized
directory or the name of its confguration.
.RE 2
.PP
\fB-k\fR, \fB--keep-remote\fR
.RS 4
Copy files from the remote directory to the local one instead of moving them.
This leaves a copy of the files in the remote directory, which is useful when
that remote directory is shared with other configurations that may also want to
retrieve the files.
.RE 2
.PP
\fB-n\fR, \fB--no-retrieve\fR
.RS 4
Don't retrieve files from the remote directory. This still de-initializes the
local directory, but leaves it with whatever files are already in it. Remote
files stay in the remote directory, and symlinks to remote files are removed
from the local directory. This is useful when you wish to reset the
configuration, but don't have enough space locally to retrieve all the files or
otherwise have to need for them.
.RE 1
.PP
\fBlist-configs\fR
.RS 4
Print a table of all initialized directories and the names of their
configurations.
.RE
.PP
\fBempty-trash\fR \fIconfig\fR|\fIpath\fR
.RS 4
Permanently delete all files in the remote directory that are marked for deletion
(see \fBTRASH\fR). This command accepts the absolute path of a local initialized
directory or the name of its configuration.
.SH SYNCING
Whenever a directory is initialized, \fBretain-sync\fR will direct the user to
start the daemon for that directory. This daemon keeps track of file access
within the initialized directory tree, adjusts file priority for time, keeps
the remote directory mounted over sshfs and runs the \fBsync\fR command hourly
by default, although this frequency can be configured in the systemd unit file
\'retain-sync-resync@.timer'. To make this change without root privileges and
only for a specific user, copy the unit file into ~/.config/systemd/user/
before editing it.
.sp
Whenever the \fBsync\fR command is run, \fBretain-sync\fR first tries to sync
the highest-priority whole subdirectories to the local directory. Directories
are synced recursively, meaning that all subdirectories are included when a
directory is synced. Once no more whole directories can fit within the
user-defined storage limit, \fBretain-sync\fR will try to sync individual files
until the storage limit is reached. This behavior can be overridden by setting
\fBsyncExtraFiles\fR to 'no' in the \fBretain-sync\fR config. Any files that
have been added since the last sync are copied to the remote directory and have
their priority artifically inflated so that they're more likely to stay in the
local directory for a while. This behavior can be overridden by setting
\fBinflatePriority\fR to 'no' in the \fBretain-sync\fR config. Any files that
have been deleted since the last sync are either removed from or marked for
deletion in the remote directory (see \fBTRASH\fR).
.sp
\fBretain-sync\fR uses \fBrsync\fR for copying files between the local and
remote directories, and should preserve symbolic links, permissions,
modification times, ownership, hard links, ACLs, extended attributes and sparse
files as long as the remote filesystem supports them.
.SH EXCLUDING
\fBretain-sync\fR allows the user to define certain files or directories to be
excluded from syncing, meaning that they will never leave the local directory.
This is done in the 'exclude' file for that configuration (see \fBFILES\fR).
To keep user-created symbolic links from being clobbered, all symbolic links
found in the local initialized directory that \fBretain-sync\fR didn't put
there are added to the exclude file automatically.  The root of each
file/directory path in the exclude file is anchored to the local initialized
directory. Another way to think of it: each file/directory path in the exclude
file is relative to the initialized directory, but must include a leading
slash.
.SH TRASH
Files that exist only in the remote directory are represented locally as
symbolic links.  Whenever the \fBsync\fR command is run, local files (including
these symbolic links) that were deleted since the last sync operation are
removed from the remote directory. If the user deletes a local symbolic link,
the file it points to won't appear in their local trash, making the file
unrecoverable. For this reason, \fBretain-sync\fR implements a simple trash
system.
.sp
Before \fBretain-sync\fR deletes a file in the remote directory, it first
searches for the file in the user's local trash directory by comparing
checksums. If it finds a copy of the file in the user's trash, then it
permanently deletes the file in the remote directory. Otherwise, it only marks
the file for deletion.  Files marked for deletion are made hidden and have
\'.trash' appended to the end of the file name. This behavior can be overridden
by setting \fBdeleteAlways\fR to \'yes' in the \fBretain-sync\fR config. The
command \fBempty-trash\fR can be used to permanently delete all files in the
remote directory that are marked for deletion. Note that when a file is marked
for deletion, it will override any previously marked file with the same name.
.SH FILES
~/.config/retain-sync/
.RS 4
This is the \fBretain-sync\fR config directory. \fBretain-sync\fR will respect
XDG_CONFIG_HOME, and if it is set, put the directory there instead.
.sp
configs/<config_name>/
.RS 4
This directory exists for each directory that has been initialized by the user,
where <config_name> is the user-specified name of the configuration.
.sp
mnt/
.RS 4
This is the sshfs mountpoint for the remote directory. Symbolic links in the
local initialized directory point to files in this directory.
.RE 3
.PP
config
.RS 4
This is the main configuration file for the initialized directory. It contains
required information that the user is prompted for when the \fBinitialize\fR
command is run as well as additional settings that can be configured.
.RE 3
.PP
exclude
.RS 4
This file contains a list of file/directory paths to be excluded from syncing
(see \fBEXCLUDING\fR).
.RE 3
.PP
priority.csv
.RS 4
This file keeps track of file priority and should not be edited by hand.
.SH AUTHOR
Garrett Powell <garrett@gpowell.net>
